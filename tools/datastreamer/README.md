# Datastream Tool

This tool was designed to be used internally with the legacy zkEVM node, but most of its options are compatible with the CDK-Erigon node, as they share the same data stream format. The only non-compatible option is the data stream generation (generate-file).

The DataStream format spec can be found [here](https://github.com/0xPolygonHermez/cdk-erigon/blob/zkevm/docs/datastream/datastream.md).

## Configuration

```
[Online]
URI = "localhost:6900"
StreamType = 1

[Offline]
Port = 6901
Filename = "datastream.bin"
Version = 4
ChainID = 1440
UpgradeEtrogBatchNumber = 0

[StateDB]
User = "state_user"
Password = "state_password"
Name = "state_db"
Host = "localhost"
Port = "5432"
EnableLog = false
MaxConns = 200

[MerkleTree]
URI = "localhost:50061"
MaxThreads = 20
CacheFile = "merkle_tree_cache.json"

[Log]
Environment = "development"
Level = "error"
Outputs = ["stdout"]
```

- **Online Section**:
    - It is used to connect to a remote data stream server. Currently only StreamType 1 exists.
- **Offline Section**:
    - It is used to work with local datastream files. This section is also used during local data stream file generation.
    - Port: The data stream library requires a port, this must be a free port in the machine where the tool is running.
    - Filename: Full path and file name of the datastream to generate or query.
    - Version: It will be added to the data stream file header. Current version is 4. Supported versions are 3 and 4. Version 4 includes a l2BlockEnd entry at the end of every l2block that version 3 lacks.
    - ChainID: L2 Chain ID. It is used during data stream files generation.
    - UpgradeEtrogBatchMNumber: Only useful for chains that started before Fork ID Etrog. This value must be the batch number of the firtst etrog batch. The reason for this is that the first batch for an upgrade to Etrog contains a transaction generated by the rollup smart contract that must be handled in a special way as it has not been sequenced by the sequencer, but synchronized from L1.
- **StateDB Section**:
    - Database access to the StateDB of the zkEVM node where the trusted state is stored. The information to generate the datastream will be extracted from here.
- **MerkleTree Section**:
    - HashDB Service offered by the Prover image. It is needed to retrieve the IM State Root for Fork ID <= Etrog. If the network is only > Etrog, set MaxThreads to 0 to disable this feature. The CacheFile is useful to speed up generations, but will only help once it has been generated on the first run.
- **Log Section**:
    - It is recommended to leave `Level` to `error` once the tool is up and running, but during configuration and until it is working, setting it to `debug` can be very helpful. 

## Options

To see avalible options type `make` once in the tool folder.

```
decode-batch                   Runs the tool to decode a given batch
decode-batch-offline           Runs the offline tool to decode a given batch
decode-batchl2data             Runs the tool to decode a given batch and show its l2 data
decode-entry                   Runs the tool to decode a given entry number
decode-entry-offline           Runs the offline tool to decode a given entry number
decode-l2block                 Runs the tool to decode a given L2 block
decode-l2block-offline         Runs the offline tool to decode a given L2 block
dump-batch                     Runs the tool to dump a given batch to file
dump-batch-offline             Runs the tool to dump a given batch to file offline
generate-file                  Runs the tool to populate the binary file
help                           Prints this help
truncate                       Runs the offline tool to truncate the stream file
```

Almost all the decode options can work online, connecting to a node serving the stream, or offline, accessing the data stream files directly. The only one that only works online is `decode-batchl2data`.

- **Decode Batch**: Decodes a Batch from a given number and shows all its data, l2blocks and transactions.
- **Decode BatchL2Data**: Decodes a Batch from a given number and shows its BatchL2Data. It may be useful to compare results against the RPC endpoint `zkevm_getBatchByNumber`.
- **Decode Entry**: Decodes an entry and shows its content. Entry can be anything: bookmark, batch start, batch end, l2block, updateGER or transaction.
- **Decode L2Block**: Decodes a L2Block from a given number and shows all its data and transactions.
- **Truncate**: Truncates the file to a given entry number. Useful in case of unwinding the network.
- **Generate file**: Connects to StateDB and MerkleTree and generates the data stream files.
- **Dump batch**: Used to extract the binary data of a batch following the DS Spec. Useful during development of the integration with the Stateless Executor and Prover to generate test vectors.

## Examples


### Generate Data Stream files

`make generate-file`

Note: `Version` and `ChainID` fields from the Offline section of the config file are used during generation, so make sure they both are correct. Current Value for Version should be `3`.


### Get contents of Batch 201 from the local files

`make decode-batch-offline 201`

```
Entry Type···············: Batch Start
Batch Number·············: 201
Batch Type···············: BATCH_TYPE_REGULAR
Chain ID ················: 2440
Entry Number·············: 17575
Entry Type···············: Batch Start
Fork ID··················: 7
Entry Type···············: BookMark
Entry Number·············: 17576
Entry Type···············: BookMark
Type·····················: 2 (BOOKMARK_TYPE_L2_BLOCK)
Value····················: 4259
Entry Type···············: L2 Block
Batch Number·············: 201
Block Gas Limit··········: 0
Block Hash···············: 0xbd2fde31c1ba2bb17f6b1edec5e7d3576ae645b4b8095b74152ad28ba4a8bab4
Block Info Root··········: 0x4e63bbbe4d34e6b3d8d531a2da5cffb4e3877414ecfe4dde24d2afaf3fd0d7a0
Coinbase·················: 0x9aeCf44E36f20DC407d1A580630c9a2419912dcB
Delta Timestamp··········: 3
Entry Number·············: 17577
Entry Type···············: L2 Block
Global Exit Root·········: 0x0000000000000000000000000000000000000000000000000000000000000000
L1 Block Hash············: 0x0000000000000000000000000000000000000000000000000000000000000000
L1 InfoTree Idx··········: 0
L2 Block Number··········: 4259
Min. Timestamp···········: 0
State Root···············: 0x0b649d223f59634d612b0b101ada69310f2f1485e7f38d8a392642229a57863b
Timestamp················: 1706276938 (2024-01-26 08:48:58 -0500 EST)
Entry Type···············: BookMark
Entry Number·············: 17579
Entry Type···············: BookMark
Type·····················: 2 (BOOKMARK_TYPE_L2_BLOCK)
Value····················: 4260
Entry Type···············: BookMark
Entry Number·············: 17582
Entry Type···············: BookMark
Type·····················: 2 (BOOKMARK_TYPE_L2_BLOCK)
Value····················: 4261
Entry Type···············: BookMark
Entry Number·············: 17586
Entry Type···············: BookMark
Type·····················: 1 (BOOKMARK_TYPE_BATCH)
Value····················: 202
Entry Type···············: BookMark
Entry Number·············: 17591
Entry Type···············: BookMark
Type·····················: 2 (BOOKMARK_TYPE_L2_BLOCK)
Value····················: 4263
Entry Type···············: Batch End
Batch Number·············: 202
Entry Number·············: 17597
Entry Type···············: Batch End
Local Exit Root··········: 0x4c907345c62b48529ce718f3a32e8be63a3ae02831386a638419c6cbe6606558
State Root···············: 0x7d2fbae3341b01aa6acb39e113fb98797f3e3da0cddb80b333ae5f8dcb916c7b
```

### Get BatchL2Data from Batch 2 in the Data Stream

`make decode-batchl2data 201`

```
BatchL2Data.....: 0x0b00000003000000000b00000003000000000b0000000300000000
```

### Get content of L2Block 1 from an online Data Stream

`make decode-l2block 1`

```
Entry Type···············: L2 Block
Batch Number·············: 1
Block Gas Limit··········: 0
Block Hash···············: 0x2d19690496337b8f0048d589c4d82820cd46a63f993cca5fc25cd738cce29dad
Block Info Root··········: 0x0000000000000000000000000000000000000000000000000000000000000000
Coinbase·················: 0x9aeCf44E36f20DC407d1A580630c9a2419912dcB
Delta Timestamp··········: 1701345162
Entry Number·············: 9
Entry Type···············: L2 Block
Global Exit Root·········: 0x0000000000000000000000000000000000000000000000000000000000000000
L1 Block Hash············: 0x0000000000000000000000000000000000000000000000000000000000000000
L1 InfoTree Idx··········: 0
L2 Block Number··········: 1
Min. Timestamp···········: 0
State Root···············: 0x9333321a6e1253c5c12922b2c1fcb4f9b6fac830d80951f4f08a640cd61dfcc4
Timestamp················: 1701345162 (2023-11-30 06:52:42 -0500 EST)
Entry Type···············: L2 Transaction
Data·····················: 0xf86a0884025625008252089488cd377500be9906c46073f54901878d1aedc72f870286db33b3c300801ca0e8941bb474e66cc662ce2cf7f52a8b45596e4bebeafd698dc6b10002ff9e04aca048b0b802b0f442fed738ba74d4d53823b3aa60bd9306002486950208b5d8cd7e
Effec. Gas Price·········: 0
Entry Number·············: 10
Entry Type···············: L2 Transaction
IM State Root ···········: 0xae431fe8723d233e04045201057e257d046ebf6d4ba93baf0d1203209b4de9ea
Index····················: 0
Is Valid·················: true
L2 Block Number··········: 1
Nonce ···················: 8
Sender···················: 0x229A5bDBb09d8555f9214F7a6784804999BA4E0D
Entry Type···············: L2 Block End
Entry Number·············: 11
Entry Type···············: L2 Block End
L2 Block Number··········: 1
```

### Get contents of Batch 201 from the local files as a JSON stream

By default, the make file targets output content in a convenient, human-readable format. The same data can be retrieved as a [newline delimited JSON](https://github.com/ndjson/ndjson-spec) stream by adding the `--json` flag.

`go run main.go decode-batch --cfg config/tool.config.toml --batch 201 --json`


```
{"Batch Number":"201","Batch Type":"BATCH_TYPE_REGULAR","Chain ID ":"10101","Entry Number":"62682","Entry Type":"Batch Start","Fork ID":"12"}
{"Entry Number":"62683","Entry Type":"BookMark","Type":"2 (BOOKMARK_TYPE_L2_BLOCK)","Value":"426"}
{"Batch Number":"201","Block Gas Limit":"0","Block Hash":"0xbc518d2e5a43f165bb0a9946fe5255a6810e638fd709dcd7065db31e6e5111cd","Block Info Root":"0x229bc3f5ea59c0628cf75a80517e0dcdb2e817177cacdf7ffa27ad05ee37d1f9","Coinbase":"0x5b06837A43bdC3dD9F114558DAf4B26ed49842Ed","Delta Timestamp":"2","Entry Number":"62684","Entry Type":"L2 Block","Global Exit Root":"0x0000000000000000000000000000000000000000000000000000000000000000","L1 Block Hash":"0x0000000000000000000000000000000000000000000000000000000000000000","L1 InfoTree Idx":"0","L2 Block Number":"426","Min. Timestamp":"0","State Root":"0x0d43082ea60965b1bf7bccb0001babf0b486390e4bf13cadb6282aae219ea8f5","Timestamp":"1727205926 (2024-09-24 15:25:26 -0400 EDT)"}
{"Data":"0xf86e82ed86843b9aca0082520894deadbeefdeadbeefdeadbeefdeadbeefdeadbeef87038d7ea4c6800080824f0da09fad01f022fa8675a5eb04a9e062eae1efed7c1e0ccac394bd821cc925b2707ba02494a393b3c6720f1c2da44a92296738724cbdbc0c0449e6b2e1e977626dc761","Effec. Gas Price":"255","Entry Number":"62685","Entry Type":"L2 Transaction","IM State Root ":"0x0000000000000000000000000000000000000000000000000000000000000000","Index":"0","Is Valid":"true","L2 Block Number":"426","Nonce ":"60806","Sender":"0xe34aaf64b29273b7d567fcfc40544c014eee9970"}
{"Data":"0xf86e82ed87843b9aca0082520894deadbeefdeadbeefdeadbeefdeadbeefdeadbeef87038d7ea4c6800080824f0da0b39f4f13d0b68095d45bbae09608d264ba09056d905d95d2fa73a5158fa1c0ffa056c06604a5d400784addd5e044f3f4be4aadbeb3d919b77e11c6867c1d53a289","Effec. Gas Price":"255","Entry Number":"62686","Entry Type":"L2 Transaction","IM State Root ":"0x0000000000000000000000000000000000000000000000000000000000000000","Index":"0","Is Valid":"true","L2 Block Number":"426","Nonce ":"60807","Sender":"0xe34aaf64b29273b7d567fcfc40544c014eee9970"}
```
